name: FortiGate Azure Marketplace Version Update

on:
  push:
    paths:
    - 'FortiGate/**'

jobs:
  ARM-FGT-Version-Update:
    name: Update FGT version list
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2

    - name: Azure Login via Az module
      uses: azure/login@v1
      with:
        creds: ${{secrets.AZURE_CREDENTIALS}}
        enable-AzPSSession: true

    - name: Package and convert templates
      shell: azure/powershell@v1bash
      run: |
        $buildingBlocks = @("A-Single-VM", "Active-Active-ELB-ILB","Active-Passive-ELB-ILB","Active-Passive-SDN")
        $fgtMarketplaceVersions = @()
        $fgtMarketplaceVersionsUI = @()

        $fortigateVersions = Get-AzVMImage -PublisherName "fortinet" -Location eastus -Offer "fortinet_fortigate-vm_v5" -sku "fortinet_fg-vm"
        $fgtMarketplaceVersions += $($fortigateVersions).Version
        $fgtMarketplaceVersions += "latest"
        $fgtMarketplaceVersions | ForEach-Object { $fgtMarketplaceVersionsUI += [pscustomobject]@{label=$_;value=$_} }

        foreach ($buildingBlock in $buildingBlocks) {
          $content = Get-Content -Raw -Path "./FortiGate/${buildingBlock}/azuredeploy.json" | ConvertFrom-Json
          $content.parameters.fortiGateImageVersion.allowedValues = $fgtMarketplaceVersions
          $content | ConvertTo-Json -depth 100 | Out-File "./FortiGate/${buildingBlock}/azuredeploy.json"

          $content = Get-Content -Raw -Path "./FortiGate/${buildingBlock}/createUiDefinition.json" | ConvertFrom-Json
          $content.parameters.basics.Where({$_.Name.equals("fortiGateImageVersion")}).constraints.allowedValues = $fgtMarketplaceVersionsUI
          $content | ConvertTo-Json -depth 100 | Out-File "./FortiGate/${buildingBlock}/createUiDefinition.json"
        }

    - name: Create Pull Request
      id: cpr
      uses: peter-evans/create-pull-request@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: Update report
        committer: GitHub <noreply@github.com>
        author: ${{ github.actor }} <${{ github.actor }}@users.noreply.github.com>
        signoff: false
        branch: fgt-vm-update-version
        delete-branch: true
        title: '[FGT] Azure Marketplace FGT Version update'
        body: |
          Update report
          - Updated FGT version in building blocks: "A-Single-VM", "Active-Active-ELB-ILB","Active-Passive-ELB-ILB","Active-Passive-SDN"
          - Auto-generated by [create-pull-request][1]

          [1]: https://github.com/peter-evans/create-pull-request
        labels: |
          report
          automated pr
        assignees: jvhoof
        reviewers: jvhoof
        milestone: 1
        draft: false
