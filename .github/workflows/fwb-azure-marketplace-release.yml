name: "[FWB] Azure Marketplace release"

on:
  push:
    tags:
      - "*"

  workflow_dispatch:

jobs:
  build:
    name: Getting all data ready for publishing
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Azure Login via Az module
        uses: azure/login@v1
        with:
          creds: ${{secrets.AZURE_CREDENTIALS}}
          enable-AzPSSession: true

      - name: Package and convert templates
        uses: azure/powershell@v1
        with:
          inlineScript: |
            $buildingBlocks = @("A-Single-VM", "Active-Active")
            $fwbMarketplaceVersions = @()
            $fwbMarketplaceVersionsUI = @()

            $fortiwebVersions = Get-AzVMImage -PublisherName "fortinet" -Location eastus -Offer "fortinet_fortiweb-vm_v5" -sku "fortinet_fw-vm"
            $fwbMarketplaceVersions += $($fortiwebVersions | Where-Object {$_.Version.StartsWith("6")} | Sort-Object -Unique -Property Version | Select-Object -Last 1).Version
            $fwbMarketplaceVersions += $($fortiwebVersions | Where-Object {$_.Version.StartsWith("7")} | Sort-Object -Unique -Property Version | Select-Object -Last 1).Version
            $fwbMarketplaceVersions += "latest"
            $fwbMarketplaceVersions | ForEach-Object { $fwbMarketplaceVersionsUI += [pscustomobject]@{label=$_;value=$_} }

            foreach ($buildingBlock in $buildingBlocks) {
              $dest = "./releases/${buildingBlock}/"
              [void](New-Item -Path "${dest}" -Type Directory)

              $content = Get-Content -Raw -Path "./FortiGate/${buildingBlock}/mainTemplate.json" | ConvertFrom-Json
              $content.parameters.fortiGateImageVersion.allowedValues = $fwbMarketplaceVersions
              $content | ConvertTo-Json -depth 100 | Out-File "${dest}/mainTemplate.json"

              $content = Get-Content -Raw -Path "./FortiGate/${buildingBlock}/createUiDefinition.json" | ConvertFrom-Json
              $content.parameters.basics.Where({$_.Name.equals("fortiGateImageVersion")}).constraints.allowedValues = $fwbMarketplaceVersionsUI
              $content | ConvertTo-Json -depth 100 | Out-File "${dest}/createUIDefinition.json"
            }
            Compress-Archive -Path "./releases/*" -DestinationPath "./releases/fortiweb-azure-templates.zip"
          azPSVersion: "latest"

#        zip -r ./releases/fortiweb-azure-templates.zip ./releases/*
      - name: upload-templates-zip
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{secrets.GITHUB_TOKEN}}
          file: ./releases/fortiweb-azure-templates.zip
          asset_name: fortiweb-azure-templates.zip
          tag: ${{github.ref}}
          overwrite: true
          body: "FortiGate Azure Marketplace Release"
