{
  "$schema": "https://schema.management.azure.com/schemas/0.1.2-preview/CreateUIDefinition.MultiVm.json#",
  "handler": "Microsoft.Azure.CreateUIDef",
  "version": "0.1.2-preview",
  "parameters": {
    "config": {
      "basics": {
        "resourceGroup": {
          "allowExisting": true
        }
      }
    },
    "resourceTypes": [
      "microsoft.resources/resourcegroups"
    ],
    "basics": [
      {
        "name": "instancetypeinfo",
        "type": "Microsoft.Common.InfoBox",
        "visible": true,
        "options": {
          "icon": "Info",
          "text": "FortiADC Deployment Type - Active/Passive with internal Load Balancer - Availability Set or Availability Zones",
          "uri": "https://github.com/fortinet/azure-templates/tree/main/FortiADC/Active-Passive-ILB"
        }
      },
      {
        "name": "adminUsername",
        "type": "Microsoft.Common.TextBox",
        "label": "FortiADC administrative username",
        "defaultValue": "",
        "toolTip": "Username for the FortiADC virtual appliance. Must not be root, administrator or admin",
        "constraints": {
          "required": true,
          "validations": [
            {
              "regex": "^[a-z0-9A-Z]{1,30}$",
              "message": "Only alphanumeric characters are allowed, and the value must be 1-30 characters long"
            },
            {
              "isValid": "[not(contains(toLower(basics('adminUsername')),'root'))]",
              "message": "Usernames must not include reserved words"
            },
            {
              "isValid": "[not(contains(toLower(basics('adminUsername')),'admin'))]",
              "message": "Usernames must not include reserved words"
            }
          ]
        },
        "visible": true
      },
      {
        "name": "adminPassword",
        "type": "Microsoft.Common.PasswordBox",
        "label": {
          "password": "FortiADC password",
          "confirmPassword": "Confirm password"
        },
        "toolTip": "Password for the Virtual Machine",
        "constraints": {
          "required": true,
          "regex": "^(?:(?=.*[a-z])(?:(?=.*[A-Z])(?=.*[\\d\\W])|(?=.*\\W)(?=.*\\d))|(?=.*\\W)(?=.*[A-Z])(?=.*\\d)).{12,}$",
          "validationMessage": "The password must be between 12 characters or longer, and contain characters from at least 3 of the following groups: uppercase characters, lowercase characters, numbers, and special characters excluding '\\' or '-'."
        },
        "options": {
          "hideConfirmation": false
        },
        "visible": true
      },
      {
        "name": "fortiADCNamePrefix",
        "type": "Microsoft.Common.TextBox",
        "label": "FortiADC Name Prefix",
        "defaultValue": "",
        "toolTip": "Naming prefix for all deployed resources",
        "constraints": {
          "required": true,
          "regex": "^[A-Za-z0-9]{1,15}$",
          "validationMessage": "Only alphanumeric characters are allowed, and the value must be 1 to 15 characters."
        },
        "visible": true
      },
      {
        "name": "fortiADCImageSKU",
        "type": "Microsoft.Common.DropDown",
        "label": "FortiADC Image SKU",
        "defaultValue": "Bring Your Own License",
        "toolTip": "Identifies whether to to use PAYG (on demand licensing) or BYOL license model (where license is purchased separately)",
        "constraints": {
          "required": false,
          "allowedValues": [
            {
              "label": "Bring Your Own License",
              "value": "fad-vm-byol"
            },
            {
              "label": "Pay As You Go - 100 Mbps",
              "value": "fortinet-fad-vm_payg-100mbps"
            },
            {
              "label": "Pay As You Go - 500 Mbps",
              "value": "fortinet-fad-vm_payg-500mbps"
            },
            {
              "label": "Pay As You Go - 1 Gbps",
              "value": "fortinet-fad-vm_payg-1gbps"
            },
            {
              "label": "Pay As You Go - 5 Gbps",
              "value": "fortinet-fad-vm_payg-5gbps"
            }
          ]
        },
        "visible": true
      },
      {
        "name": "fortiADCImageVersion",
        "type": "Microsoft.Common.DropDown",
        "label": "FortiADC Image Version",
        "defaultValue": "latest",
        "toolTip": "Select the image version",
        "constraints": {
          "required": false,
          "allowedValues": [
            {
              "label": "6.1.3",
              "value": "6.1.3"
            },
            {
              "label": "6.2.0",
              "value": "6.2.0"
            },
            {
              "label": "7.0.1",
              "value": "7.0.1"
            },
            {
              "label": "latest",
              "value": "latest"
            }
          ]
        },
        "visible": true
      },
      {
        "name": "availabilityOptions",
        "type": "Microsoft.Common.DropDown",
        "label": "FortiGate Availability Options",
        "defaultValue": "Availability Set",
        "toolTip": "Deploy FortiGate VMs in an Availability Set or Availability Zones. If Availability Zones deployment is selected but the location does not support Availability Zones an Availability Set will be deployed. If Availability Zones deployment is selected and Availability Zones are available in the location, FortiGate A will be placed in Zone 1, FortiGate B will be placed in Zone 2",
        "constraints": {
          "required": false,
          "allowedValues": [
            {
              "label": "Availability Set",
              "value": "Availability Set"
            },
            {
              "label": "Availability Zones",
              "value": "Availability Zones"
            }
          ]
        },
        "visible": true
      }
    ],
    "steps": [
      {
        "name": "instancetype",
        "label": "Instance Type",
        "subLabel": {
          "preValidation": "Select instance type",
          "postValidation": "Done"
        },
        "elements": [
          {
            "name": "instancetypeinfo",
            "type": "Microsoft.Common.TextBlock",
            "visible": true,
            "options": {
              "text": "For this FortiADC deployment, it is recommended to use the general purpose or compute optimized virtual machines. A selection of supported instances sizes is listed in our documentation.",
              "link": {
                "label": "Learn more",
                "uri": "https://docs.fortinet.com/document/fortiweb-public-cloud/latest/about-fortiweb-for-azure/527834/instance-type-support"
              }
            }
          },
          {
            "name": "instancetypeselection",
            "type": "Microsoft.Compute.SizeSelector",
            "label": "Size",
            "toolTip": "Select the instance size of your FortiADC VM solution. Minimum 4 NICs are required.",
            "recommendedSizes": [
              "Standard_F2s",
              "Standard_F1",
              "Standard_F2",
              "Standard_F4",
              "Standard_F8",
              "Standard_F16",
              "Standard_F1s",
              "Standard_F2s",
              "Standard_F4s",
              "Standard_F8s",
              "Standard_F16s",
              "Standard_F2s_v2",
              "Standard_F4s_v2",
              "Standard_F8s_v2",
              "Standard_F16s_v2",
              "Standard_F32s_v2",
              "Standard_D1_v2",
              "Standard_D2_v2",
              "Standard_D3_v2",
              "Standard_D4_v2",
              "Standard_D5_v2",
              "Standard_DS1_v2",
              "Standard_DS2_v2",
              "Standard_DS3_v2",
              "Standard_DS4_v2",
              "Standard_DS5_v2",
              "Standard_D2_v3",
              "Standard_D4_v3",
              "Standard_D8_v3",
              "Standard_D16_v3",
              "Standard_D32_v3",
              "Standard_D2s_v3",
              "Standard_D4s_v3",
              "Standard_D8s_v3",
              "Standard_D16s_v3",
              "Standard_D32s_v3"
            ],
            "constraints": {
              "allowedValues": [
                "Standard_F2s",
                "Standard_F1",
                "Standard_F2",
                "Standard_F4",
                "Standard_F8",
                "Standard_F16",
                "Standard_F1s",
                "Standard_F2s",
                "Standard_F4s",
                "Standard_F8s",
                "Standard_F16s",
                "Standard_F2s_v2",
                "Standard_F4s_v2",
                "Standard_F8s_v2",
                "Standard_F16s_v2",
                "Standard_F32s_v2",
                "Standard_D1_v2",
                "Standard_D2_v2",
                "Standard_D3_v2",
                "Standard_D4_v2",
                "Standard_D5_v2",
                "Standard_DS1_v2",
                "Standard_DS2_v2",
                "Standard_DS3_v2",
                "Standard_DS4_v2",
                "Standard_DS5_v2",
                "Standard_D2_v3",
                "Standard_D4_v3",
                "Standard_D8_v3",
                "Standard_D16_v3",
                "Standard_D32_v3",
                "Standard_D2s_v3",
                "Standard_D4s_v3",
                "Standard_D8s_v3",
                "Standard_D16s_v3",
                "Standard_D32s_v3"
              ]
            },
            "options": {
              "hideDiskTypeFilter": false
            },
            "osPlatform": "Linux",
            "imageReference": {
              "publisher": "Fortinet",
              "offer": "fortinet_fortiweb-vm_v5",
              "sku": "[basics('fortiADCImageSKU')]"
            },
            "count": 2,
            "visible": true
          },
          {
            "name": "loadbalancersku",
            "type": "Microsoft.Common.DropDown",
            "label": "Azure Internal Load Balancer SKU",
            "defaultValue": "Basic",
            "toolTip": "",
            "constraints": {
              "required": false,
              "allowedValues": [
                {
                  "label": "Basic",
                  "value": "Basic"
                },
                {
                  "label": "Standard",
                  "value": "Standard"
                }
              ]
            },
            "visible": true
          }
        ]
      },
      {
        "name": "networking",
        "label": "Networking",
        "subLabel": {
          "preValidation": "Configure internal networking",
          "postValidation": "Done"
        },
        "elements": [
          {
            "name": "virtualnetworksection",
            "type": "Microsoft.Common.Section",
            "label": "Configure Internal Networking",
            "elements": [
              {
                "name": "virtualnetworktext",
                "type": "Microsoft.Common.TextBlock",
                "visible": true,
                "options": {
                  "text": "Create a new or select an existing virtual network with the required subnets."
                }
              },
              {
                "name": "virtualnetwork",
                "type": "Microsoft.Network.VirtualNetworkCombo",
                "label": {
                  "virtualNetwork": "Virtual network",
                  "subnets": "Subnets"
                },
                "toolTip": {
                  "virtualNetwork": "Virtual Network for deployment of the FortiADC VM solution",
                  "subnets": "Requirement to have 4 subnets connected to the FortiADC VM: external, internal"
                },
                "defaultValue": {
                  "name": "[if(equals(basics('fortiADCNamePrefix'),''),'FortiADC-VNET',concat(basics('fortiADCNamePrefix'),'-VNET'))]",
                  "addressPrefixSize": "/20"
                },
                "constraints": {
                  "minAddressPrefixSize": "/26"
                },
                "options": {
                  "hideExisting": false
                },
                "subnets": {
                  "subnet1": {
                    "label": "External Subnet",
                    "defaultValue": {
                      "name": "ExternalSubnet",
                      "addressPrefixSize": "/26"
                    },
                    "constraints": {
                      "minAddressPrefixSize": "/29",
                      "minAddressCount": 2,
                      "requireContiguousAddresses": true
                    }
                  },
                  "subnet2": {
                    "label": "Internal subnet",
                    "defaultValue": {
                      "name": "InternalSubnet",
                      "addressPrefixSize": "/26"
                    },
                    "constraints": {
                      "minAddressPrefixSize": "/29",
                      "minAddressCount": 3,
                      "requireContiguousAddresses": true
                    }
                  }
                },
                "visible": true
              },
              {
                "name": "virtualnetworkinfo",
                "type": "Microsoft.Common.InfoBox",
                "visible": true,
                "options": {
                  "icon": "Info",
                  "text": "The selected subnets should be empty and will only be used by the FortiADC VMs network interfaces.",
                  "uri": "https://github.com/fortinet/azure-templates/tree/main/FortiADC/Active-Passive"
                }
              }
            ]
          }
        ]
      }
    ],
    "outputs": {
      "fortiADCNamePrefix": "[basics('fortiADCNamePrefix')]",
      "fortiADCImageSKU": "[basics('fortiADCImageSKU')]",
      "fortiADCImageVersion": "[basics('fortiADCImageVersion')]",
      "adminUsername": "[basics('adminUsername')]",
      "adminPassword": "[basics('adminPassword')]",
      "availabilityOptions": "[basics('availabilityOptions')]",
      "location": "[location()]",
      "instanceType": "[steps('instancetype').instancetypeselection]",
      "internalLoadBalancerSKU": "[steps('instancetype').loadbalancersku]",
      "vnetNewOrExisting": "[steps('networking').virtualnetworksection.virtualnetwork.newOrExisting]",
      "vnetName": "[steps('networking').virtualnetworksection.virtualnetwork.name]",
      "vnetResourceGroup": "[steps('networking').virtualnetworksection.virtualnetwork.resourceGroup]",
      "vnetAddressPrefix": "[steps('networking').virtualnetworksection.virtualnetwork.addressPrefix]",
      "subnet1Name": "[steps('networking').virtualnetworksection.virtualnetwork.subnets.subnet1.name]",
      "subnet1Prefix": "[steps('networking').virtualnetworksection.virtualnetwork.subnets.subnet1.addressPrefix]",
      "subnet1StartAddress": "[steps('networking').virtualnetworksection.virtualnetwork.subnets.subnet1.startAddress]",
      "subnet2Name": "[steps('networking').virtualnetworksection.virtualnetwork.subnets.subnet2.name]",
      "subnet2Prefix": "[steps('networking').virtualnetworksection.virtualnetwork.subnets.subnet2.addressPrefix]",
      "subnet2StartAddress": "[steps('networking').virtualnetworksection.virtualnetwork.subnets.subnet2.startAddress]"
    }
  }
}
